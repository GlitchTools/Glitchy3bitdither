<!doctype html>
<html>
    <head>
        <title>3 bit dither</title>
    </head>
     <body>

        <canvas id="canvas"></canvas>

        <script type="text/javascript">
            var img = new Image();
            img.onload = function(){
                var width = img.width;
                var height = img.height;

                var canvas = document.getElementById('canvas');
                canvas.width = width;
                canvas.height = height;
                var ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                var imageData = ctx.getImageData(0, 0, width, height);

                for (var y = 0; y < height; y++) {
                    for (var x = 0; x < width; x++) {
                        i = 4 * (y * width + x);
                        old_r = imageData.data[i]
                        old_g = imageData.data[i + 1]
                        old_b = imageData.data[i + 2];

                        new_r = (old_r > 127) ? 0xff : 0;
                        new_g = (old_g > 127) ? 0xff : 0;
                        new_b = (old_b > 127) ? 0xff : 0;

                        imageData.data[i] = new_r;
                        imageData.data[i + 1] = new_g;
                        imageData.data[i + 2] = new_b;

                        err_r = old_r - new_r;
                        err_g = old_g - new_g;
                        err_b = old_b - new_b;

                        // Redistribute the pixel's error like this:
                        //   * 7
                        // 3 5 1 

                        // The ones to the right...
                        if (x < width - 1) {
                            right_i = i + 4;
                            imageData.data[right_i] = imageData.data[right_i] + 7/16 * err_r; 
                            imageData.data[right_i + 1] = imageData.data[right_i + 1] + 7/16 * err_g; 
                            imageData.data[right_i + 2] = imageData.data[right_i + 2] + 7/16 * err_b; 

                            // The pixel that's down and to the right
                            if (y < height - 1) {
                                next_right_i = right_i + (width * 4)
                                imageData.data[next_right_i] = imageData.data[next_right_i] + 1/16 * err_r; 
                                imageData.data[next_right_i + 1] = imageData.data[next_right_i + 1] + 1/16 * err_g; 
                                imageData.data[next_right_i + 2] = imageData.data[next_right_i + 2] + 1/16 * err_b; 
                            }
                        }
                        
                        if (y < height - 1) {
                            // The one right below
                            down_i = i + (width * 4);
                            imageData.data[down_i] = imageData.data[down_i] + 5/16 * err_r;
                            imageData.data[down_i + 1] = imageData.data[down_i + 1] + 5/16 * err_g;
                            imageData.data[down_i + 2] = imageData.data[down_i + 2] + 5/16 * err_b;

                            if (x > 0) {
                                // The one down and to the left...
                                left_i = down_i - 4;
                                imageData.data[left_i] = imageData.data[left_i] + 3/16 * err_r;
                                imageData.data[left_i + 1] = imageData.data[left_i + 1] + 3/16 * err_g;
                                imageData.data[left_i + 2] = imageData.data[left_i + 2] + 3/16 * err_b;
                            }
                        }
                    }
                }

                ctx.putImageData(imageData, 0, 0);
                window.location= canvas.toDataURL("image/png");
            };
            img.src = "meghan.jpg";
        </script>
    </body>
</html>
