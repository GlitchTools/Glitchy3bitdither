<!doctype html>
<html>
    <head>
        <title>3 bit dither</title>
        <style>
            body {
                font-family: san-serif;
                font-size: 12px;
            }
        </style>
    </head>
     <body>
        <h1>3 Bit Dither</h1>
        <div style="width:600px;">
            <p>Implemented by Nolan Caudill, code on github <a href="https://github.com/mncaudill/3bitdither">here</a></p>
            <p>This demo currently uses two different error-diffusion dithering algorithms: <a href="http://verlagmartinkoch.at/software/dither/index.html">Atkinson's</a> and the <a href="http://en.wikipedia.org/wiki/Floyd%E2%80%93Steinberg_dithering">Floyd-Steinberg</a> algorithm.

            <p>Error-diffusion means that the algorithm goes pixel by pixel, rounds the individual R, G, and B channels to either 0x00 or 0xff, and then distributes those differences (which the algorithm calls the "quantization error") in differing amounts to pixels further down the line. It being a 3-bit dithering means that your red, blue, and green channels are represented by a single bit (off or on), giving you a total of 8 colors.</p>

<p>This runs completely client-side, using the FileReader and canvas APIs. If you have a somewhat modern browser, this should work. Also, you can right-click and save the result of the dithering.</p>
        </div>

        <input type="file" id="uploader">

        <br>
        
        <script type="text/javascript">
            // The filereader code was ripped unceremoniously from http://www.html5rocks.com/en/tutorials/file/dndfiles/
            document.getElementById('uploader').addEventListener('change', handleFileSelect, false);

            function drawDitherResult(canvas, ditherer, text) {
                var ctx = canvas.getContext('2d');
                var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                ditherer(imageData);
                ctx.putImageData(imageData, 0, 0);

                var img = new Image();
                img.src = canvas.toDataURL("image/png");

                h2 = document.createElement('h2');
                h2.innerText = text;

                document.body.appendChild(h2);
                document.body.appendChild(img);
            }

            function handleFileSelect(e) {
                var file = e.target.files[0];

                // Only process image files.
                if (!file.type.match('image.*')) {
                    return;
                }

                var reader = new FileReader();

                // Closure to capture the file information.
                reader.onload = function(e) {
                    var img = new Image();
                    img.onload = function(){
                        var width = img.width;
                        var height = img.height;

                        var canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;

                        var ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);

                        drawDitherResult(canvas, ditherAtkinsons, 'Atkinson\'s');

                        ctx.drawImage(img, 0, 0); // Reset

                        drawDitherResult(canvas, ditherFloydSteinberg, 'Floyd-Steinberg');
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);

                this.style.display = 'none';
            }

            function adjustPixel(data, i, error, multiplier) {
                data[i] = data[i] + multiplier * error[0]; 
                data[i + 1] = data[i + 1] + multiplier * error[1]; 
                data[i + 2] = data[i + 2] + multiplier * error[2]; 
            }

            function ditherAtkinsons(imageData) {
                var width = imageData.width,
                    height = imageData.height,
                    data = imageData.data;
                for (var y = 0; y < height; y++) {
                    for (var x = 0; x < width; x++) {
                        i = 4 * (y * width + x);
                        old_r = data[i]
                        old_g = data[i + 1]
                        old_b = data[i + 2];

                        new_r = (old_r > 127) ? 0xff : 0;
                        new_g = (old_g > 127) ? 0xff : 0;
                        new_b = (old_b > 127) ? 0xff : 0;

                        data[i] = new_r;
                        data[i + 1] = new_g;
                        data[i + 2] = new_b;

                        err_r = old_r - new_r;
                        err_g = old_g - new_g;
                        err_b = old_b - new_b;

                        // Redistribute the pixel's error like this:
                        //       *  1/8 1/8
                        //  1/8 1/8 1/8
                        //      1/8 

                        // The ones to the right...
                        if (x < width - 1) {
                            adj_i = i + 4;
                            adjustPixel(data, adj_i, [err_r, err_g, err_b], 1/8);

                            // The pixel that's down and to the right
                            if (y < height - 1) {
                                adj_i = adj_i + (width * 4) + 4;
                                adjustPixel(data, adj_i, [err_r, err_g, err_b], 1/8);
                            }

                            // The pixel two over
                            if (x < width - 2) {
                                adj_i = i + 8;
                                adjustPixel(data, adj_i, [err_r, err_g, err_b], 1/8);
                            }
                        }

                        if (y < height - 1) {
                            // The one right below
                            adj_i = i + (width * 4);
                            adjustPixel(data, adj_i, [err_r, err_g, err_b], 1/8);

                            if (x > 0) {
                                // The one to the left
                                adj_i = adj_i - 4;
                                adjustPixel(data, adj_i, [err_r, err_g, err_b], 1/8);
                            }

                            if (y < height - 2) {
                                // The one two down
                                adj_i = i + (2 * width * 4);
                                adjustPixel(data, adj_i, [err_r, err_g, err_b], 1/8);
                            }
                        }
                    }
                }
            }

            function ditherFloydSteinberg(imageData) {
                var width = imageData.width,
                    height = imageData.height,
                    data = imageData.data;
                for (var y = 0; y < height; y++) {
                    for (var x = 0; x < width; x++) {
                        i = 4 * (y * width + x);
                        old_r = data[i]
                        old_g = data[i + 1]
                        old_b = data[i + 2];

                        new_r = (old_r > 127) ? 0xff : 0;
                        new_g = (old_g > 127) ? 0xff : 0;
                        new_b = (old_b > 127) ? 0xff : 0;

                        data[i] = new_r;
                        data[i + 1] = new_g;
                        data[i + 2] = new_b;

                        err_r = old_r - new_r;
                        err_g = old_g - new_g;
                        err_b = old_b - new_b;

                        // Redistribute the pixel's error like this:
                        //   * 7
                        // 3 5 1 

                        // The ones to the right...
                        if (x < width - 1) {
                            right_i = i + 4;
                            adjustPixel(data, right_i, [err_r, err_g, err_b], 7/16);

                            // The pixel that's down and to the right
                            if (y < height - 1) {
                                next_right_i = right_i + (width * 4)
                                adjustPixel(data, next_right_i, [err_r, err_g, err_b], 1/16);
                            }
                        }
                        
                        if (y < height - 1) {
                            // The one right below
                            down_i = i + (width * 4);
                            adjustPixel(data, down_i, [err_r, err_g, err_b], 5/16);

                            if (x > 0) {
                                // The one down and to the left...
                                left_i = down_i - 4;
                                adjustPixel(data, left_i, [err_r, err_g, err_b], 3/16);
                            }
                        }
                    }
                }
            }
        </script>
    </body>
</html>
