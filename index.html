<!doctype html>
<html>
    <head>
        <title>3 bit dither</title>
    </head>
     <body>
        <h1>3 Bit Dither</h1>
        <div style="width:600px;">
            <p>Implemented by Nolan Caudill, code on <a href="https://github.com/mncaudill/3bitdither">github</a></p>
        <p>This particular dither uses the <a href="http://en.wikipedia.org/wiki/Floyd%E2%80%93Steinberg_dithering">Floyd-Steinberg algorithm</a> 
that goes pixel by pixel, rounds the individual R, G, and B channels to either 0x00 or 0xff, and then distributes those differences (which the algorithm calls the "quantization error") in differing amounts to pixels further down the line. This algorithm squeezes your palette down to just 8 colors, while still giving a decent approximation of the original image.</p>
<p>This runs completely client-side, using the FileReader and canvas APIs. If you have a somewhat modern browser, this should work. Also, you can right-click and save the result of the dithering.</p>
        </div>

        <input type="file" id="uploader">

        <br>
        
        <script type="text/javascript">
            // The filereader code was ripped unceremoniously from http://www.html5rocks.com/en/tutorials/file/dndfiles/
            document.getElementById('uploader').addEventListener('change', handleFileSelect, false);

            function handleFileSelect(e) {
                var file = e.target.files[0];

                // Only process image files.
                if (!file.type.match('image.*')) {
                    return;
                }

                var reader = new FileReader();

                // Closure to capture the file information.
                reader.onload = function(e) {
                    dither3bit(e.target.result);
                }
                reader.readAsDataURL(file);
            }

            function dither3bit(uri) {
                var img = new Image();
                img.onload = function(){
                    var width = img.width;
                    var height = img.height;

                    var canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    var ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    var imageData = ctx.getImageData(0, 0, width, height);

                    for (var y = 0; y < height; y++) {
                        for (var x = 0; x < width; x++) {
                            i = 4 * (y * width + x);
                            old_r = imageData.data[i]
                            old_g = imageData.data[i + 1]
                            old_b = imageData.data[i + 2];

                            new_r = (old_r > 127) ? 0xff : 0;
                            new_g = (old_g > 127) ? 0xff : 0;
                            new_b = (old_b > 127) ? 0xff : 0;

                            imageData.data[i] = new_r;
                            imageData.data[i + 1] = new_g;
                            imageData.data[i + 2] = new_b;

                            err_r = old_r - new_r;
                            err_g = old_g - new_g;
                            err_b = old_b - new_b;

                            // Redistribute the pixel's error like this:
                            //   * 7
                            // 3 5 1 

                            // The ones to the right...
                            if (x < width - 1) {
                                right_i = i + 4;
                                imageData.data[right_i] = imageData.data[right_i] + 7/16 * err_r; 
                                imageData.data[right_i + 1] = imageData.data[right_i + 1] + 7/16 * err_g; 
                                imageData.data[right_i + 2] = imageData.data[right_i + 2] + 7/16 * err_b; 

                                // The pixel that's down and to the right
                                if (y < height - 1) {
                                    next_right_i = right_i + (width * 4)
                                    imageData.data[next_right_i] = imageData.data[next_right_i] + 1/16 * err_r; 
                                    imageData.data[next_right_i + 1] = imageData.data[next_right_i + 1] + 1/16 * err_g; 
                                    imageData.data[next_right_i + 2] = imageData.data[next_right_i + 2] + 1/16 * err_b; 
                                }
                            }
                            
                            if (y < height - 1) {
                                // The one right below
                                down_i = i + (width * 4);
                                imageData.data[down_i] = imageData.data[down_i] + 5/16 * err_r;
                                imageData.data[down_i + 1] = imageData.data[down_i + 1] + 5/16 * err_g;
                                imageData.data[down_i + 2] = imageData.data[down_i + 2] + 5/16 * err_b;

                                if (x > 0) {
                                    // The one down and to the left...
                                    left_i = down_i - 4;
                                    imageData.data[left_i] = imageData.data[left_i] + 3/16 * err_r;
                                    imageData.data[left_i + 1] = imageData.data[left_i + 1] + 3/16 * err_g;
                                    imageData.data[left_i + 2] = imageData.data[left_i + 2] + 3/16 * err_b;
                                }
                            }
                        }
                    }

                    ctx.putImageData(imageData, 0, 0);
                    canvas.style.display = "none";

                    img.src = canvas.toDataURL("image/png");
                    document.body.appendChild(img);
                };
                img.src = uri;
            }
        </script>
    </body>
</html>
